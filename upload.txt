upload 
"""
File Upload Functionality Tests
Tests file upload and project creation
"""
import sys
import os
import random
import string
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from selenium.webdriver.common.by import By
from test_base import BaseTest
from test_config import BASE_URL, TEST_USERNAME, TEST_PASSWORD
import time

class TestUpload(BaseTest):
    """File upload functionality tests"""
    
    def generate_random_username(self):
        """Generate random username for testing"""
        return f"testuser_{''.join(random.choices(string.ascii_lowercase + string.digits, k=8))}"
    
    def login_first(self):
        """Helper to login before upload tests"""
        try:
            self.driver.get(f"{self.base_url}/login")
            time.sleep(2)
            
            username_input = self.wait_for_element(By.ID, "name")
            password_input = self.wait_for_element(By.ID, "password")
            
            if username_input and password_input:
                username_input.clear()
                username_input.send_keys(TEST_USERNAME)
                password_input.clear()
                password_input.send_keys(TEST_PASSWORD)
                
                login_btn = self.wait_for_element(By.CSS_SELECTOR, "button[type='submit']")
                if login_btn:
                    login_btn.click()
                    time.sleep(3)
                    return True
            return False
        except:
            return False
    
    def test_upload_page_access(self):
        """Test if upload page is accessible after login"""
        try:
            if not self.setup():
                return self.record_test_result("Upload Page Access", "error", "Browser setup failed", 0)
            
            start_time = time.time()
            
            if self.login_first():
                # Check if on upload page
                if "/authenticate" in self.driver.current_url or "index" in self.driver.current_url or "upload" in self.driver.current_url.lower():
                    file_input = self.wait_for_element(By.CSS_SELECTOR, "input[type='file']")
                    if file_input:
                        duration = time.time() - start_time
                        return self.record_test_result("Upload Page Access", "pass", "Upload page accessible with file input", duration)
                    else:
                        screenshot = self.take_screenshot("upload_page_no_file_input")
                        duration = time.time() - start_time
                        return self.record_test_result("Upload Page Access", "fail", "Upload page loaded but file input not found", duration, screenshot)
                else:
                    screenshot = self.take_screenshot("upload_page_not_accessible")
                    duration = time.time() - start_time
                    return self.record_test_result("Upload Page Access", "fail", f"Not on upload page. Current URL: {self.driver.current_url}", duration, screenshot)
            else:
                screenshot = self.take_screenshot("login_failed_for_upload")
                duration = time.time() - start_time
                return self.record_test_result("Upload Page Access", "fail", "Login failed, cannot access upload page", duration, screenshot)
                
        except Exception as e:
            screenshot = self.take_screenshot("upload_page_access_error")
            return self.record_test_result("Upload Page Access", "error", str(e), time.time() - start_time if 'start_time' in locals() else 0, screenshot)
        finally:
            self.teardown()
    
    def test_upload_form_elements(self):
        """Test if upload form has all required elements"""
        try:
            if not self.setup():
                return self.record_test_result("Upload Form Elements", "error", "Browser setup failed", 0)
            
            start_time = time.time()
            
            if self.login_first():
                file_input = self.wait_for_element(By.CSS_SELECTOR, "input[type='file']")
                submit_btn = self.wait_for_element(By.CSS_SELECTOR, "button[type='submit'], input[type='submit']")
                
                if file_input and submit_btn:
                    duration = time.time() - start_time
                    return self.record_test_result("Upload Form Elements", "pass", "All upload form elements present", duration)
                else:
                    missing = []
                    if not file_input:
                        missing.append("file input")
                    if not submit_btn:
                        missing.append("submit button")
                    screenshot = self.take_screenshot("upload_form_missing_elements")
                    duration = time.time() - start_time
                    return self.record_test_result("Upload Form Elements", "fail", f"Missing elements: {', '.join(missing)}", duration, screenshot)
            else:
                screenshot = self.take_screenshot("login_failed_for_form_test")
                duration = time.time() - start_time
                return self.record_test_result("Upload Form Elements", "fail", "Login failed", duration, screenshot)
                
        except Exception as e:
            screenshot = self.take_screenshot("upload_form_elements_error")
            return self.record_test_result("Upload Form Elements", "error", str(e), time.time() - start_time if 'start_time' in locals() else 0, screenshot)
        finally:
            self.teardown()
    
    def test_simple_file_upload(self):
        """Simple file upload test - 30 lines"""
        test_file = None
        try:
            if not self.setup():
                return self.record_test_result("Simple File Upload", "error", "Browser setup failed", 0)
            start_time = time.time()
            if self.login_first():
                file_input = self.wait_for_element(By.CSS_SELECTOR, "input[type='file']")
                if file_input:
                    test_file = os.path.join(os.path.dirname(__file__), "test_file.txt")
                    with open(test_file, "w") as f:
                        f.write("test content")
                    file_input.send_keys(test_file)
                    submit_btn = self.wait_for_element(By.CSS_SELECTOR, "button[type='submit']")
                    if submit_btn:
                        submit_btn.click()
                        time.sleep(2)
                        duration = time.time() - start_time
                        if test_file and os.path.exists(test_file):
                            os.remove(test_file)
                        return self.record_test_result("Simple File Upload", "pass", "File uploaded successfully", duration)
            screenshot = self.take_screenshot("simple_upload_failed")
            return self.record_test_result("Simple File Upload", "fail", "Upload failed", time.time() - start_time, screenshot)
        except Exception as e:
            return self.record_test_result("Simple File Upload", "error", str(e), time.time() - start_time if 'start_time' in locals() else 0)
        finally:
            if test_file and os.path.exists(test_file):
                try:
                    os.remove(test_file)
                except:
                    pass
            self.teardown()
    
    def run_all_tests(self):
        """Run all upload tests"""
        results = []
        results.append(self.test_upload_page_access())
        results.append(self.test_upload_form_elements())
        results.append(self.test_simple_file_upload())
        return results

